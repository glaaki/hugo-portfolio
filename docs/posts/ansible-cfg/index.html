<!doctype html><html lang=en><head><title>Config - Be Explicit :: Sean Porter — Technologist, Problem Solver, Maker</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="The Motivation: We rely on ansible for some deploys &amp;amp; to enforce certain state at our retail locations; I was burned by an upgrade to this system last week and thought it would be nice to talk about what happened and what could have been done to prevent it.
The Incident: I built some tooling around automated playbook retries because the connection to some of our hosts is pretty bad (3G levels of bad&amp;hellip;); across ~5500 hosts something is almost guaranteed to fail."><meta name=keywords content><meta name=robots content=noodp><link rel=canonical href=/posts/ansible-cfg/><link rel=stylesheet href=/assets/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content=summary><meta name=twitter:title content="Config - Be Explicit :: Sean Porter — Technologist, Problem Solver, Maker"><meta name=twitter:description content="The Motivation: We rely on ansible for some deploys &amp;amp; to enforce certain state at our retail locations; I was burned by an upgrade to this system last week and thought it would be nice to talk about what happened and what could have been done to prevent it.
The Incident: I built some tooling around automated playbook retries because the connection to some of our hosts is pretty bad (3G levels of bad&amp;hellip;); across ~5500 hosts something is almost guaranteed to fail."><meta name=twitter:site content=/><meta name=twitter:creator content><meta name=twitter:image content><meta property=og:locale content=en><meta property=og:type content=article><meta property=og:title content="Config - Be Explicit :: Sean Porter — Technologist, Problem Solver, Maker"><meta property=og:description content="The Motivation: We rely on ansible for some deploys &amp;amp; to enforce certain state at our retail locations; I was burned by an upgrade to this system last week and thought it would be nice to talk about what happened and what could have been done to prevent it.
The Incident: I built some tooling around automated playbook retries because the connection to some of our hosts is pretty bad (3G levels of bad&amp;hellip;); across ~5500 hosts something is almost guaranteed to fail."><meta property=og:url content=/posts/ansible-cfg/><meta property=og:site_name content="Config - Be Explicit"><meta property=og:image content><meta property=og:image:width content=2048><meta property=og:image:height content=1024><meta property=article:published_time content="2019-08-26 15:38:59 -0500 CDT"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>~/SeanPorter</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>about</a></li><li><a href=/posts>posts</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>about</a></li><li><a href=/posts>posts</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/ansible-cfg/>Config - Be Explicit</a></h1><div class=post-meta><span class=post-date>2019-08-26</span></div><div class=post-content><h1 id=the-motivation>The Motivation:</h1><p>We rely on ansible for some deploys &amp; to enforce certain state at our retail locations; I was burned by an upgrade to this system last week and thought it would be nice to talk about what happened and what could have been done to prevent it.</p><h1 id=the-incident>The Incident:</h1><p>I built some tooling around automated playbook retries because the connection to some of our hosts is pretty bad (3G levels of bad&hellip;); across ~5500 hosts something is almost guaranteed to fail. In a nutshell my wrapper takes an inventory and playbook name, checks a specific directory for any retry files (which would imply that playbook had already run) and runs the playbook against any remaining hosts.</p><p>I noticed that these playbooks were running against <em>all</em> the hosts every time; but couldn&rsquo;t immediately figure out why. All the directories looked fine, correct permissions, etc. I examined the config file and <code>retry_files_save_path</code> was what I expected, so nothing jumped out as an obvious issue. Running ansible with <code>-vvv</code> didn&rsquo;t give any clues. There was no mention of retry files at all, which was strange because I expected at least <em>some</em> kind of error.</p><p><img src=/stock/ugh.jpg alt=ugh title="Photo by Nathan Dumlao on Unsplash"></p><h1 id=the-problem>The Problem:</h1><p>After digging into the docs for an embarassingly long time, I realized a default had changed in a recent ansible version. <code>retry_files_enabled</code> wasn&rsquo;t in our ansible.cfg at all because <code>retry_files_enabled=True</code> was the default, but this newer version of ansible defaulted to <code>retry_files_enabled=False</code> instead.</p><h1 id=what-i-learned>What I Learned:</h1><p>I was implicitly relying on some behavior that changed and didn&rsquo;t catch it in the changelogs. If you rely on some specific behavior of a system, be explicit &amp; put it in the config. If I wanted to generalize here, I would say it&rsquo;s good practice to think about what assumptions you are making about environment and find some way to explicitly enforce them.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/ender3/><span class=button__icon>←</span>
<span class=button__text>3D Printer</span></a></span>
<span class="button next"><a href=/posts/helidox/><span class=button__text>The Keyboard Of Many Names</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2019 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>